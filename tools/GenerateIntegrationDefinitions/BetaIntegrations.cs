using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using Datadog.Trace.TestHelpers;

namespace GenerateIntegrationDefinitions
{
    public static class BetaIntegrations
    {
        private const string EntryTemplate = @"""{0}""_W";
        private const string Spacing = @"                                                 ";
        private const string EndVector = @"};";

        private static readonly string FileTemplate = @"
#pragma once
#include ""clr_helpers.h""

// This file is automatically generated. Any changes made will be lost
namespace trace {
inline std::vector<WSTRING> beta_integrations = {{entries}
}  // namespace trace

";

        public static void CreateFile(IEnumerable<string> betaIntegrations)
        {
            var content = FileTemplate;

            var transformedEntries =
                betaIntegrations
                   .Select(entry => string.Format(EntryTemplate, entry.Replace("Integration", string.Empty)))
                   .ToList();
            var entries = string.Join($",{Environment.NewLine}{Spacing}", transformedEntries);
            entries = entries + EndVector;
            content = content.Replace("{entries}", entries);

            var solutionDirectory = EnvironmentHelper.GetSolutionDirectory();
            var filePath = Path.Combine(solutionDirectory, "src", "Datadog.Trace.ClrProfiler.Native", "beta_integrations.h");

            File.WriteAllText(filePath, content, new UTF8Encoding(encoderShouldEmitUTF8Identifier: false));
        }
    }
}
