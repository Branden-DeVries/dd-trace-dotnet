trigger:
  batch: 'true'
  branches:
    include:
      - master
  paths:
    exclude:
      - docs/*
      - .github/*

variables:
  - name: buildConfiguration
    value: Debug
  - template: templates/variables/build.yml

jobs:

- job: Linux

  pool:
    vmImage: ubuntu-16.04

  steps:
  - template: templates/steps/linux-integration-tests-setup.yml

  - task: DockerCompose@0
    displayName: docker-compose run IntegrationTests
    inputs:
      containerregistrytype: Container Registry
      dockerComposeCommand: run -e TestAllPackageVersions=true IntegrationTests

  - task: PublishTestResults@2
    displayName: publish test results
    inputs:
      testResultsFormat: VSTest
      testResultsFiles: test/**/*.trx
    condition: succeededOrFailed()

- job: Windows

  pool:
    vmImage: windows-2019

  variables:
    buildPlatform: 'x64'

  steps:
  - template: templates/steps/windows-integration-tests-setup.yml

  - task: DotNetCoreCLI@2
    displayName: dotnet test
    inputs:
      command: test
      configuration: $(buildConfiguration)
      projects: test/Datadog.Trace.ClrProfiler.IntegrationTests/Datadog.Trace.ClrProfiler.IntegrationTests.csproj
      arguments: '--filter "RunOnWindows=True|Category=Smoke" -p:Platform=$(buildPlatform)'
